<div class="my-purchases">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">My Purchases</h1>
    <p class="page-subtitle">View your purchase history</p>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filter-row">
      <div class="filter-group">
        <label for="searchSweetId">Sweet ID:</label>
        <input
          id="searchSweetId"
          type="number"
          pInputText
          [(ngModel)]="filters.sweetId"
          (input)="onSearchChange()"
          placeholder="Enter sweet ID"
          class="filter-input"
        />
      </div>

      <div class="filter-group">
        <label for="startDate">Start Date:</label>
        <input
          id="startDate"
          type="date"
          pInputText
          [(ngModel)]="filters.startDate"
          (input)="onDateRangeChange()"
          class="filter-input"
        />
      </div>

      <div class="filter-group">
        <label for="endDate">End Date:</label>
        <input
          id="endDate"
          type="date"
          pInputText
          [(ngModel)]="filters.endDate"
          (input)="onDateRangeChange()"
          class="filter-input"
        />
      </div>

      <div class="filter-group">
        <label for="sortBy">Sort By:</label>
        <p-select
          id="sortBy"
          [(ngModel)]="filters.sortBy"
          [options]="[
            { label: 'ID', value: 'id' },
            { label: 'Purchase Date', value: 'purchasedAt' },
            { label: 'Quantity', value: 'quantity' },
          ]"
          optionLabel="label"
          optionValue="value"
          (onChange)="onSortChange()"
          class="filter-select"
        >
        </p-select>
      </div>

      <div class="filter-group">
        <label for="sortOrder">Sort Order:</label>
        <p-select
          id="sortOrder"
          [(ngModel)]="filters.sortOrder"
          [options]="[
            { label: 'Ascending', value: 'asc' },
            { label: 'Descending', value: 'desc' },
          ]"
          optionLabel="label"
          optionValue="value"
          (onChange)="onSortChange()"
          class="filter-select"
        >
        </p-select>
      </div>

      <div class="filter-actions">
        <p-button
          label="Clear Filters"
          icon="pi pi-times"
          severity="secondary"
          [text]="true"
          (onClick)="clearFilters()"
        >
        </p-button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
      <p class="loading-text">Loading your purchases...</p>
    </div>
  }

  <!-- Purchases Table -->
  @if (!isLoading) {
    <div class="table-container">
      <p-table
        [value]="purchases"
        [loading]="isLoading"
        [paginator]="true"
        [rows]="rowsPerPage"
        [totalRecords]="totalRecords"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} purchases"
        [rowsPerPageOptions]="[10, 20, 50]"
        dataKey="id"
        (onPage)="onPageChange($event)"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>ID</th>
            <th>Sweet</th>
            <th>Category</th>
            <th>Quantity</th>
            <th>Unit Price</th>
            <th>Total Price</th>
            <th>Purchase Date</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-purchase>
          <tr>
            <td>{{ purchase.id }}</td>
            <td>
              <div class="sweet-info">
                <div class="sweet-name">
                  {{ purchase.sweet?.name || 'Unknown' }}
                </div>
              </div>
            </td>
            <td>
              <span class="category-name">{{
                purchase.sweet?.category?.name || 'N/A'
              }}</span>
            </td>
            <td>
              <span class="quantity">{{ purchase.quantity }}</span>
            </td>
            <td>
              <span class="unit-price">{{
                formatPrice(parsePrice(purchase.sweet?.price))
              }}</span>
            </td>
            <td>
              <span class="total-price">{{
                formatPrice(getTotalPrice(purchase))
              }}</span>
            </td>
            <td>
              <span class="purchase-date">{{
                purchase.purchasedAt | date: 'short'
              }}</span>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center">
              <div class="empty-state">
                <i class="pi pi-shopping-cart text-4xl text-neutral-300"></i>
                <h3>No purchases found</h3>
                <p>You haven't made any purchases yet.</p>
                <p-button
                  label="Browse Sweets"
                  icon="pi pi-box"
                  severity="primary"
                  [routerLink]="['/customer']"
                >
                </p-button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  }
</div>
