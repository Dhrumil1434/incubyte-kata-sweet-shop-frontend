<div class="purchase-management">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">Purchase Management</h1>
    <div class="header-actions">
      <p-button
        label="Refresh"
        icon="pi pi-refresh"
        severity="secondary"
        [text]="true"
        (onClick)="loadPurchases()"
        [loading]="isLoading"
      >
      </p-button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filter-row">
      <div class="filter-group">
        <label for="searchUserId">User ID:</label>
        <input
          id="searchUserId"
          type="number"
          pInputText
          [(ngModel)]="filters.userId"
          (input)="onSearchChange()"
          placeholder="Enter user ID"
          class="filter-input"
        />
      </div>

      <div class="filter-group">
        <label for="searchSweetId">Sweet ID:</label>
        <input
          id="searchSweetId"
          type="number"
          pInputText
          [(ngModel)]="filters.sweetId"
          (input)="onSearchChange()"
          placeholder="Enter sweet ID"
          class="filter-input"
        />
      </div>

      <div class="filter-group">
        <label for="startDate">Start Date:</label>
        <input
          id="startDate"
          type="date"
          pInputText
          [(ngModel)]="filters.startDate"
          (input)="onDateRangeChange()"
          class="filter-input"
        />
      </div>

      <div class="filter-group">
        <label for="endDate">End Date:</label>
        <input
          id="endDate"
          type="date"
          pInputText
          [(ngModel)]="filters.endDate"
          (input)="onDateRangeChange()"
          class="filter-input"
        />
      </div>

      <div class="filter-group">
        <label for="sortBy">Sort By:</label>
        <p-select
          id="sortBy"
          [(ngModel)]="filters.sortBy"
          [options]="[
            { label: 'ID', value: 'id' },
            { label: 'Purchase Date', value: 'purchasedAt' },
            { label: 'Quantity', value: 'quantity' },
          ]"
          optionLabel="label"
          optionValue="value"
          (onChange)="onSortChange()"
          class="filter-select"
        >
        </p-select>
      </div>

      <div class="filter-group">
        <label for="sortOrder">Sort Order:</label>
        <p-select
          id="sortOrder"
          [(ngModel)]="filters.sortOrder"
          [options]="[
            { label: 'Ascending', value: 'asc' },
            { label: 'Descending', value: 'desc' },
          ]"
          optionLabel="label"
          optionValue="value"
          (onChange)="onSortChange()"
          class="filter-select"
        >
        </p-select>
      </div>

      <div class="filter-actions">
        <p-button
          label="Clear Filters"
          icon="pi pi-times"
          severity="secondary"
          [text]="true"
          (onClick)="clearFilters()"
        >
        </p-button>
      </div>
    </div>
  </div>

  <!-- Purchases Table -->
  <div class="table-container">
    <p-table
      [value]="purchases"
      [loading]="isLoading"
      [paginator]="true"
      [rows]="rowsPerPage"
      [totalRecords]="totalRecords"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} purchases"
      [rowsPerPageOptions]="[10, 20, 50]"
      [selectionMode]="'multiple'"
      [(selection)]="selectedPurchases"
      dataKey="id"
      (onPage)="onPageChange($event)"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th>ID</th>
          <th>User</th>
          <th>Sweet</th>
          <th>Category</th>
          <th>Quantity</th>
          <th>Unit Price</th>
          <th>Total Price</th>
          <th>Purchase Date</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-purchase>
        <tr>
          <td>
            <p-tableCheckbox [value]="purchase"></p-tableCheckbox>
          </td>
          <td>{{ purchase.id }}</td>
          <td>
            <div class="user-info">
              <div class="user-name">
                {{ purchase.user?.name || 'Unknown' }}
              </div>
              <div class="user-email">{{ purchase.user?.email || 'N/A' }}</div>
            </div>
          </td>
          <td>
            <div class="sweet-name">
              {{ purchase.sweet?.name || 'Unknown' }}
            </div>
          </td>
          <td>
            <span class="category-name">{{
              purchase.sweet?.category?.name || 'N/A'
            }}</span>
          </td>
          <td>
            <span class="quantity">{{ purchase.quantity }}</span>
          </td>
          <td>
            <span class="unit-price">{{
              formatPrice(parsePrice(purchase.sweet?.price))
            }}</span>
          </td>
          <td>
            <span class="total-price">{{
              formatPrice(getTotalPrice(purchase))
            }}</span>
          </td>
          <td>
            <span class="purchase-date">{{
              purchase.purchasedAt | date: 'short'
            }}</span>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center">
            <div class="empty-state">
              <i class="pi pi-shopping-cart text-4xl text-neutral-300"></i>
              <p>No purchases found</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
